generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum HabitStatus {
  planned
  active
  paused
  built
  cancelled
}

enum HabitRunStatus {
  active
  paused
  built
  cancelled
}

enum HabitDayStatus {
  completed
  missed
  unmarked
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum UserRole {
  OWNER
  MEMBER
}

model User {
  id    String   @id @default(uuid())
  email String   @unique
  role  UserRole @default(MEMBER)

  timezone String @default("UTC")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authAccounts    AuthAccount[]
  habits          Habit[]
  refreshSessions RefreshSession[]

  @@index([email])
}

model AuthAccount {
  id         String       @id @default(uuid())
  userId     String
  provider   AuthProvider
  providerId String
  password   String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

model RefreshSession {
  id        String  @id @default(uuid())
  userId    String
  tokenHash String
  userAgent String?
  ip        String?

  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Habit {
  id     String      @id @default(uuid())
  title  String
  status HabitStatus

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs HabitRun[]

  @@index([status])
  @@index([userId])
}

model HabitRun {
  id      String @id @default(uuid())
  habitId String

  status    HabitRunStatus
  totalDays Int

  startDate   DateTime
  builtAt     DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())

  habit   Habit         @relation(fields: [habitId], references: [id], onDelete: Cascade)
  dayLogs HabitDayLog[]

  @@index([habitId])
  @@index([status])
}

model HabitDayLog {
  id         String         @id @default(uuid())
  habitRunId String
  date       DateTime
  status     HabitDayStatus
  createdAt  DateTime       @default(now())

  habitRun HabitRun @relation(fields: [habitRunId], references: [id], onDelete: Cascade)

  @@unique([habitRunId, date])
  @@index([habitRunId])
}
